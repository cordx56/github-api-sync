# GitHub API Sync

GitHubのAPIを用いてObsidianのVaultを同期するプラグイン。

src/以下のファイルに記述されている。

## 仕様

APIリクエストを効率的に行うため、リクエストはGraphQLを主に用いること。ただし、一部のAPIはGraphQLにないため、REST APIを使っている。

### 同期手順

同期は以下の手順で行う。

1. GitHubのAPIを用いて、GitHubのリポジトリのデフォルトブランチの最新コミットのファイル一覧を取得する。
2. ローカルに保存している最終同期日時とローカルにある全ファイルの更新日時を比較し、最終同期日時以降に更新されたファイル一覧を取得する。
3. ローカルの最終同期日時を含む直前のコミットとGitHubのリポジトリのデフォルトブランチの最新コミットとの差分をAPIで取得する。
4. ローカルで更新されたファイル一覧とリモートのコミット間の差分のあったファイル一覧を比較する。ローカルでのみ更新があったファイルの一覧をアップロード対象として、リモートのみで更新があったファイルをダウンロード対象として、両方で更新があったファイルをコンフリクトとして記録する。
5. アップロード対象をアップロードしてコミット、ダウンロード対象をダウンロードしてローカルのファイルを上書きする。Promise.allなどを用いて並列に行うこと。
6. コンフリクトしたファイルをダウンロードし、ローカルとマージを試みる。失敗した場合、diffをローカルに保存する。
7. 現在の日時を最終同期日時としてローカルに保存する。

### 設定画面

設定画面では、以下の情報を保存できるようにしておく。

- GitHubのユーザ名
- GitHubのPAT
- リポジトリのパス（ユーザ名/リポジトリ、のフォーマット）
- ダウンロードするファイルの最大サイズ
- 許可する操作（Pullのみ/Pushのみ/Bidirectional）

#### 自動同期機能

- 自動同期モードの選択（Disable、Interval、OnSave）
- 自動同期を行う最小の間隔（分）

### 画面表示

- ステータスバーに同期状況を表示する。ファイルの操作であれば、どれだけのファイル数に対してどこまで処理が終わったかも明示する。

### サイドバー

サイドバーを実装する。

- サイドバーにはブランチ選択欄、選択されたブランチのコミット履歴を表示する
- 各コミットにはチェックボックスをつける
- コミットの名前が選択された場合、GitHubのコミット詳細リンクを開く。
- チェックをつけた単一のコミットのチェックアウト、単一のコミットのrevert、複数のコミットのsquash機能を提供する。

### 自動同期

自動同期機能を実装する。

- 設定に応じ、最小の時間間隔か保存時に同期を行う。
- 保存時の同期は、保存してから3秒待機し、その間に他の更新がなかった場合のみ実行される。

### 注意事項

- .gitignoreで指定されたファイルは操作を行わないこと。gitignore-parserライブラリを用いることができる。各ディレクトリの.gitignoreを読んで確認すること。
- diffはjsdiffライブラリを用いて取ることができる。
- モバイルのObsidianでも動くよう、APIリクエストはutils.tsのrequest関数群を用いること。octokitは削除してください。
